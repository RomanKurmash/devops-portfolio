groups:
  - name: infrastructure
    rules:
      # 1. Watchdog (Замість старого AlertingSystemWorking)
      # Цей алерт завжди активний. Ми НЕ шлемо його в ТГ (бот ігнорує його), 
      # але він потрібен для перевірки, що Prometheus бачить Alertmanager.
      - alert: Watchdog
        expr: vector(1)
        labels:
          severity: heartbeat
          container: "monitoring"
        annotations:
          summary: "Monitoring pipeline is alive"

      # 2. Nginx: Більш стійкі тригери
      - alert: NginxExporterDown
        expr: up{job="nginx"} == 0
        for: 3m # Збільшено до 3 хв, щоб ігнорувати короткі рестарти
        labels:
          severity: critical
          container: "nginx-proxy" # Важливо для логів
        annotations:
          summary: "Nginx Exporter Down"
          description: "Exporter for Nginx is unreachable."

      - alert: NginxHighErrorRate
        expr: rate(nginx_http_requests_total{status=~"5.."}[5m]) > 0.5 # Поріг піднято для меншого шуму
        for: 15m # Тільки якщо стабільно сипле помилками
        labels:
          severity: warning
          container: "nginx-proxy"

      # 3. MySQL: Усунення помилкових спрацювань
      - alert: MySQLDown
        expr: absent(container_last_seen{name="mysql-db"}) or (time() - container_last_seen{name="mysql-db"} > 60)
        for: 5m # Даємо базі час на "роздуми" або автоматичний рестарт
        labels:
          severity: critical
          container: "mysql-db" # Важливо для логів
        annotations:
          summary: "MySQL database is DOWN"
          description: "MySQL container has been missing for more than 5 minutes."

      # 4. Система (Node Exporter)
      - alert: HighCPUUsage
        expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90 # Піднято до 90%
        for: 10m
        labels:
          severity: warning
          container: "node-exporter"
        annotations:
          summary: "Extreme CPU usage on {{ $labels.instance }}"