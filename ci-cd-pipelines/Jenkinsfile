pipeline {
    agent any
    
    options {
        disableConcurrentBuilds()
        timeout(time: 15, unit: 'MINUTES')
        retry(2)  // –î–æ–¥–∞—î–º–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö
    }
    
    environment {
        COMPOSE_PROJECT_NAME = 'devops-portfolio'
        INFRA_DIR = 'app-infrastructure'
    }
    
    stages {
        stage('üì• Checkout & Setup') {
            steps {
                echo 'üöÄ Starting Docker Pipeline on Jenkins Master'
                checkout scm
                
                sh '''
                    echo "=== üìÅ WORKSPACE CONTENTS ==="
                    pwd
                    ls -la
                    echo "=== üê≥ DOCKER ENVIRONMENT ==="
                    docker --version
                    docker-compose --version
                    docker ps | head -10
                '''
            }
        }
        
        stage('üîß Pre-Deployment Setup') {
            steps {
                sh """
                    echo "=== üõ†Ô∏è PRE-DEPLOYMENT SETUP ==="
                    cd ${INFRA_DIR}
                    
                    # –°—Ç–≤–æ—Ä—é—î–º–æ –º–µ—Ä–µ–∂—ñ (—è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—é—Ç—å)
                    echo "üì° Creating networks..."
                    docker network create ${COMPOSE_PROJECT_NAME}_apps-net 2>/dev/null || echo "Network apps-net already exists"
                    docker network create ${COMPOSE_PROJECT_NAME}_monitor-net 2>/dev/null || echo "Network monitor-net already exists"
                    
                    # –§—ñ–∫—Å –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó MySQL Exporter
                    echo "üîß Fixing MySQL Exporter config..."
                    if [ -f "mysql-exporter/my.cnf" ]; then
                        sed -i '1s/^[^a-zA-Z[]*//' mysql-exporter/my.cnf
                        echo "‚úÖ MySQL Exporter config cleaned"
                    else
                        echo "‚ö†Ô∏è MySQL Exporter config not found"
                    fi
                    
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∫–æ–º–ø–æ–∑ —Ñ–∞–π–ª—ñ–≤
                    echo "üìã Checking compose files..."
                    ls -la *.yml || echo "No YML files found"
                """
            }
        }
        
        stage('üõë Clean Previous Deployment') {
            steps {
                sh """
                    echo "=== üßπ CLEANING PREVIOUS DEPLOYMENT ==="
                    cd ${INFRA_DIR}
                    
                    # –ó—É–ø–∏–Ω—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
                    docker-compose -f docker-compose.apps.yml down --remove-orphans 2>/dev/null || true
                    docker-compose -f docker-compose.monitoring.yml down --remove-orphans 2>/dev/null || true
                    
                    echo "‚úÖ Previous containers stopped"
                """
            }
        }
        
        stage('üöÄ Deploy Applications') {
            steps {
                sh """
                    echo "=== üöÄ DEPLOYING APPLICATIONS ==="
                    cd ${INFRA_DIR}
                    
                    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–æ–¥–∞—Ç–∫–∏
                    docker-compose -f docker-compose.apps.yml up -d --build
                    
                    echo "‚è≥ Waiting for applications to start..."
                    sleep 10
                    
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å
                    echo "üîç Applications status:"
                    docker-compose -f docker-compose.apps.yml ps
                """
            }
        }
        
        stage('üìä Deploy Monitoring') {
            steps {
                sh """
                    echo "=== üìä DEPLOYING MONITORING ==="
                    cd ${INFRA_DIR}
                    
                    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
                    docker-compose -f docker-compose.monitoring.yml up -d --build
                    
                    echo "‚è≥ Waiting for monitoring to start..."
                    sleep 15
                    
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å
                    echo "üîç Monitoring status:"
                    docker-compose -f docker-compose.monitoring.yml ps
                """
            }
        }
        
        stage('‚úÖ Health Checks & Validation') {
            steps {
                sh """
                    echo "=== ‚úÖ HEALTH CHECKS ==="
                    
                    # –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ
                    check_service() {
                        local url=\$1
                        local service=\$2
                        local max_attempts=5
                        local attempt=1
                        
                        while [ \$attempt -le \$max_attempts ]; do
                            if curl -f -s -o /dev/null -w "%{http_code}" "\$url" | grep -q "200\\|301\\|302"; then
                                echo "‚úÖ \$service is HEALTHY (attempt \$attempt)"
                                return 0
                            fi
                            echo "‚è≥ Waiting for \$service... (attempt \$attempt/\$max_attempts)"
                            sleep 10
                            attempt=\$((attempt + 1))
                        done
                        echo "‚ùå \$service is DOWN after \$max_attempts attempts"
                        return 1
                    }
                    
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å–µ—Ä–≤—ñ—Å–∏
                    echo "--- Service Health Checks ---"
                    check_service "http://localhost" "WordPress" || true
                    check_service "http://localhost:3000" "Grafana" || true
                    check_service "http://localhost:9090" "Prometheus" || true
                    check_service "http://localhost:9093" "Alertmanager" || true
                    
                    # –§—ñ–Ω–∞–ª—å–Ω–∏–π —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
                    echo ""
                    echo "--- Final Container Status ---"
                    cd ${INFRA_DIR}
                    echo "üì¶ APPLICATIONS:"
                    docker-compose -f docker-compose.apps.yml ps
                    echo ""
                    echo "üìä MONITORING:"
                    docker-compose -f docker-compose.monitoring.yml ps
                    
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ª–æ–≥—ñ –Ω–∞ –ø–æ–º–∏–ª–∫–∏
                    echo ""
                    echo "--- Error Check ---"
                    docker-compose -f docker-compose.apps.yml logs --tail=5 | grep -i error || echo "‚úÖ No recent errors in apps"
                    docker-compose -f docker-compose.monitoring.yml logs --tail=5 | grep -i error || echo "‚úÖ No recent errors in monitoring"
                """
            }
        }
    }
    
    post {
        always {
            echo "=== üìä PIPELINE EXECUTION SUMMARY ==="
            sh """
                echo "--- Running Containers ---"
                docker ps --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"
                
                echo ""
                echo "--- Resource Usage ---"
                docker stats --no-stream --format "table {{.Name}}\\t{{.CPUPerc}}\\t{{.MemUsage}}" | head -10
                
                echo ""
                echo "--- Quick Access URLs ---"
                echo "üåê WordPress:    http://localhost"
                echo "üìà Grafana:      http://localhost:3000 (admin/admin)"
                echo "üìä Prometheus:   http://localhost:9090"
                echo "üö® Alertmanager: http://localhost:9093"
                echo "üîÑ Jenkins:      http://localhost:8080"
            """
            
            // –û—á–∏—â–∞—î–º–æ —Ä–µ—Å—É—Ä—Å–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ
            script {
                if (currentBuild.result == 'FAILURE') {
                    echo "üßπ Cleaning up due to failure..."
                    sh """
                        cd ${INFRA_DIR}
                        docker-compose -f docker-compose.apps.yml down 2>/dev/null || true
                        docker-compose -f docker-compose.monitoring.yml down 2>/dev/null || true
                    """
                }
            }
        }
        
        success {
            echo "‚úÖ üéâ PIPELINE EXECUTED SUCCESSFULLY!"
            echo "All services deployed and ready"
            
            // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Ç—É—Ç
            // telegramSend message: "‚úÖ Deployment successful! Services are running."
        }
        
        failure {
            echo "‚ùå PIPELINE FAILED"
            echo "Check the logs above for details"
            
            // –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
            sh """
                echo "--- Last 10 lines of logs ---"
                cd ${INFRA_DIR}
                docker-compose -f docker-compose.apps.yml logs --tail=10 2>/dev/null || echo "No apps logs"
                docker-compose -f docker-compose.monitoring.yml logs --tail=10 2>/dev/null || echo "No monitoring logs"
            """
        }
        
        unstable {
            echo "‚ö†Ô∏è PIPELINE UNSTABLE"
            echo "Some health checks failed but deployment completed"
        }
    }
}