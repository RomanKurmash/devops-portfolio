pipeline {
    agent any
    
    options {
        disableConcurrentBuilds()
        timeout(time: 20, unit: 'MINUTES')
        retry(1)
    }
    
    environment {
        COMPOSE_PROJECT_NAME = 'devops-portfolio'
        INFRA_DIR = 'app-infrastructure'
    }
    
    stages {
        stage('üì• Checkout & Validate') {
            steps {
                echo 'üöÄ Starting CI/CD Pipeline for DevOps Portfolio'
                checkout scm
                
                sh '''
                    echo "=== üìÅ WORKSPACE VALIDATION ==="
                    pwd
                    ls -la
                    echo "=== üê≥ DOCKER ENVIRONMENT CHECK ==="
                    docker --version
                    docker-compose --version
                    docker compose version
                    echo "=== üìÇ PROJECT STRUCTURE ==="
                    find . -name "*.yml" -o -name "*.yaml" | head -20
                '''
            }
        }
        
        stage('üîß Pre-Deployment Setup') {
            steps {
                sh """
                    echo "=== üõ†Ô∏è PRE-DEPLOYMENT CONFIGURATION ==="
                    cd ${INFRA_DIR}
                    
                    # –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –º–µ—Ä–µ–∂—ñ
                    echo "üì° Setting up Docker networks..."
                    docker network create ${COMPOSE_PROJECT_NAME}_apps-net 2>/dev/null || echo "Network apps-net already exists"
                    docker network create ${COMPOSE_PROJECT_NAME}_monitor-net 2>/dev/null || echo "Network monitor-net already exists"
                    
                    # –§—ñ–∫—Å –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó MySQL Exporter
                    echo "üîß Configuring MySQL Exporter..."
                    if [ -f "mysql-exporter/my.cnf" ]; then
                        # –í–∏–¥–∞–ª—è—î–º–æ –±—É–¥—å-—è–∫—ñ –Ω–µ-ASCII —Å–∏–º–≤–æ–ª–∏ –∑ –ø–æ—á–∞—Ç–∫—É —Ñ–∞–π–ª—É
                        sed -i '1s/^[^a-zA-Z[]*//' mysql-exporter/my.cnf
                        echo "‚úÖ MySQL Exporter config cleaned"
                    else
                        echo "‚ö†Ô∏è MySQL Exporter config not found, creating default..."
                        mkdir -p mysql-exporter
                        cat > mysql-exporter/my.cnf << 'EOF'
[client]
user=exporter
password=password
host=mysql
EOF
                    fi
                    
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ —Ñ–∞–π–ª–∏
                    echo "üìã Verifying configuration files..."
                    ls -la docker-compose*.yml 2>/dev/null && echo "‚úÖ Compose files found" || echo "‚ùå Compose files missing"
                """
            }
        }
        
        stage('üõë Clean Previous Deployment') {
            steps {
                sh """
                    echo "=== üßπ CLEANING PREVIOUS DEPLOYMENT ==="
                    cd ${INFRA_DIR}
                    
                    # –ó—É–ø–∏–Ω—è—î–º–æ —Ç–∞ –≤–∏–¥–∞–ª—è—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
                    docker-compose -f docker-compose.apps.yml down --remove-orphans 2>/dev/null || echo "No previous apps to clean"
                    docker-compose -f docker-compose.monitoring.yml down --remove-orphans 2>/dev/null || echo "No previous monitoring to clean"
                    
                    echo "‚úÖ Environment cleaned"
                """
            }
        }
        
        stage('üöÄ Deploy Applications') {
            steps {
                sh """
                    echo "=== üöÄ DEPLOYING APPLICATIONS ==="
                    cd ${INFRA_DIR}
                    
                    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–æ–¥–∞—Ç–∫–∏
                    echo "üì¶ Starting WordPress stack..."
                    docker-compose -f docker-compose.apps.yml up -d --build
                    
                    # –ß–µ–∫–∞—î–º–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
                    echo "‚è≥ Waiting for applications to initialize..."
                    sleep 30
                    
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å
                    echo "üîç Applications status:"
                    docker-compose -f docker-compose.apps.yml ps
                    echo ""
                    echo "üìä Applications logs (last 5 lines):"
                    docker-compose -f docker-compose.apps.yml logs --tail=5 2>/dev/null || echo "No logs available"
                """
            }
        }
        
        stage('üìä Deploy Monitoring') {
            steps {
                sh """
                    echo "=== üìä DEPLOYING MONITORING STACK ==="
                    cd ${INFRA_DIR}
                    
                    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
                    echo "üìà Starting monitoring services..."
                    docker-compose -f docker-compose.monitoring.yml up -d --build
                    
                    # –ß–µ–∫–∞—î–º–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
                    echo "‚è≥ Waiting for monitoring to start..."
                    sleep 25
                    
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å
                    echo "üîç Monitoring status:"
                    docker-compose -f docker-compose.monitoring.yml ps
                    echo ""
                    echo "üìã Monitoring logs (last 5 lines):"
                    docker-compose -f docker-compose.monitoring.yml logs --tail=5 2>/dev/null || echo "No logs available"
                """
            }
        }
        
        stage('‚úÖ Health Checks & Validation') {
            steps {
                sh """
                    echo "=== ‚úÖ COMPREHENSIVE HEALTH CHECKS ==="
                    
                    # –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å–µ—Ä–≤—ñ—Å—ñ–≤
                    check_service() {
                        local service=\$1
                        local port=\$2
                        local max_attempts=10
                        local attempt=1
                        
                        echo "üîç Checking \$service on port \$port..."
                        
                        while [ \$attempt -le \$max_attempts ]; do
                            if nc -z localhost \$port 2>/dev/null; then
                                echo "‚úÖ \$service is HEALTHY (port \$port)"
                                return 0
                            fi
                            echo "‚è≥ Waiting for \$service... (attempt \$attempt/\$max_attempts)"
                            sleep 10
                            attempt=\$((attempt + 1))
                        done
                        echo "‚ùå \$service is UNHEALTHY after \$max_attempts attempts"
                        return 1
                    }
                    
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –±–∞–∑–æ–≤—É –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å –ø–æ—Ä—Ç—ñ–≤
                    echo "--- Port Availability Check ---"
                    check_service "WordPress" "80" || echo "‚ö†Ô∏è WordPress might be still starting"
                    check_service "Grafana" "3000" || echo "‚ö†Ô∏è Grafana might be still starting"
                    check_service "Prometheus" "9090" || echo "‚ö†Ô∏è Prometheus might be still starting"
                    check_service "Alertmanager" "9093" || echo "‚ö†Ô∏è Alertmanager might be still starting"
                    
                    # –î–µ—Ç–∞–ª—å–Ω–∏–π —Å—Ç–∞—Ç—É—Å –≤—Å—ñ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
                    echo ""
                    echo "--- Detailed Container Status ---"
                    cd ${INFRA_DIR}
                    echo "üì¶ APPLICATIONS:"
                    docker-compose -f docker-compose.apps.yml ps -a
                    echo ""
                    echo "üìä MONITORING:"
                    docker-compose -f docker-compose.monitoring.yml ps -a
                    
                    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ª–æ–≥–∏ –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏
                    echo ""
                    echo "--- Error Log Check ---"
                    echo "Applications:"
                    docker-compose -f docker-compose.apps.yml logs --tail=10 2>/dev/null | grep -i "error\\|fail\\|exception" || echo "‚úÖ No critical errors in apps"
                    echo ""
                    echo "Monitoring:"
                    docker-compose -f docker-compose.monitoring.yml logs --tail=10 2>/dev/null | grep -i "error\\|fail\\|exception" || echo "‚úÖ No critical errors in monitoring"
                """
            }
        }
    }
    
    post {
        always {
            echo "=== üìä DEPLOYMENT EXECUTION REPORT ==="
            sh """
                echo "--- Final Container Overview ---"
                docker ps --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}" 2>/dev/null | head -15
                
                echo ""
                echo "--- Resource Usage Summary ---"
                docker stats --no-stream --format "table {{.Name}}\\t{{.CPUPerc}}\\t{{.MemUsage}}" 2>/dev/null | head -10
                
                echo ""
                echo "--- Network Configuration ---"
                docker network ls | grep ${COMPOSE_PROJECT_NAME} || echo "No project networks found"
                
                echo ""
                echo "--- Quick Access Guide ---"
                echo "üåê WordPress:     http://localhost"
                echo "üìä Grafana:       http://localhost:3000 (admin/admin)"
                echo "üìà Prometheus:    http://localhost:9090"
                echo "üö® Alertmanager:  http://localhost:9093"
                echo "üîÑ Jenkins:       http://localhost:8080"
                echo ""
                echo "--- Useful Commands ---"
                echo "View all logs:    cd ${INFRA_DIR} && docker-compose logs"
                echo "Restart services: cd ${INFRA_DIR} && docker-compose restart"
                echo "Stop all:         cd ${INFRA_DIR} && docker-compose down"
            """
            
            // Cleanup on failure
            script {
                if (currentBuild.result == 'FAILURE') {
                    echo "üßπ Performing cleanup due to pipeline failure..."
                    sh """
                        cd ${INFRA_DIR} || exit 0
                        docker-compose -f docker-compose.apps.yml down 2>/dev/null || true
                        docker-compose -f docker-compose.monitoring.yml down 2>/dev/null || true
                    """
                }
            }
        }
        
        success {
            echo "‚úÖ üéâ PIPELINE EXECUTED SUCCESSFULLY!"
            echo "All services have been deployed and are running"
            echo "Check the Quick Access Guide above for URLs"
            
            // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —Ç—É—Ç
            // telegramSend message: "‚úÖ DevOps Portfolio deployed successfully!"
            // slackSend channel: '#deployments', message: "Deployment completed successfully"
        }
        
        failure {
            echo "‚ùå PIPELINE FAILED"
            echo "Investigation steps:"
            echo "1. Check container logs above"
            echo "2. Verify Docker network configuration"
            echo "3. Check resource availability (CPU, Memory)"
            echo "4. Review application configuration files"
            
            sh """
                echo "--- Debug Information ---"
                echo "Docker system info:"
                docker system df 2>/dev/null || echo "Docker not available"
                echo ""
                echo "Recent container events:"
                docker events --since 10m --until 0 2>/dev/null | tail -10 || echo "Cannot retrieve events"
            """
        }
        
        unstable {
            echo "‚ö†Ô∏è PIPELINE COMPLETED WITH WARNINGS"
            echo "Some health checks failed but core services are running"
            echo "Check the health check section above for details"
        }
    }
}